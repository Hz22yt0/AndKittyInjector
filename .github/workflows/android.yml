name: Android CI

on:
  push:
    branches:
      - "main"
    paths:
      - "CHANGELOG.md"
  workflow_dispatch:


jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ver_name: "v1.0.0"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    permissions: # 声明所需权限:ml-citation{ref="1" data="citationList"}
      contents: write    # 仓库内容写入权限（包含repo）
      packages: write    # 包管理写入权限

    steps:
    - uses: actions/checkout@v4

    - name: Download Command Line Tools
      run: |
          cd ${{ github.workspace }}/AndKittyInjector
          #find /usr/local/lib/android/ -name make
          #find /usr/local/lib/android/ -name cmake
          #ls
          sh ndk-build.sh

  release:
    needs: build  # 依赖构建任务完成:ml-citation{ref="7,8" data="citationList"}
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ github.workspace }}/AndKittyInjector/cmake_build/*  # 下载到统一目录:ml-citation{ref="3" data="citationList"}
      - name: Create Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          files: |
            ${{ github.workspace }}/AndKittyInjector/cmake_build/AndKittyInjector-arm64-v8a-release.gz
            ${{ github.workspace }}/AndKittyInjector/cmake_build/AndKittyInjector-armeabi-v7a-release.gz
            ${{ github.workspace }}/AndKittyInjector/cmake_build/AndKittyInjector-x86-release.gz
            ${{ github.workspace }}/AndKittyInjector/cmake_build/AndKittyInjector-x86_64-release.gz
          tag_name: v${{ github.run_number }}  # 自动生成版本标签:ml-citation{ref="7,10" data="citationList"}
          body: ${{ github.workspace }}/CHANGELOG.md